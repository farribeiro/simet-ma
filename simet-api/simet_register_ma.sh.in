#!/bin/sh
# Refreshes SIMET SIMET MA agent-id and auth token (generic)
# Copyright (c) 2018,2019 NIC.br <medicoes@simet.nic.br>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.  In every case, additional
# restrictions and permissions apply, refer to the COPYING file in the
# program Source for details.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License and the COPYING file in the program Source
# for details.

# parameters:
#   --boot   (optional) shorten wait times and not restart the service

OUTFILE=
abend() {
	simet_log simet-ma daemon.err "$*"
	[ -n "$OUTFILE" ] && rm -f "$OUTFILE" 2>/dev/null
	exit 1
}

is_call_implemented() {
	command -V $1 > /dev/null 2>&1
}

call() {
	cmd="$1"
	shift
	if is_call_implemented ${cmd}_override ; then
		${cmd}_override "$@"
        else
		${cmd} "$@"
	fi
}

call_hook() {
	cmd="$1"
	shift
	if is_call_implemented ${cmd} ; then
		${cmd} "$@"
	fi
}

. @SIMETLIBDIR@/simet_lib.sh

AGENT_ID_FILE=${AGENT_ID_FILE:-@SIMETCONFDIR@/agent-id}
AGENT_TOKEN_FILE=${AGENT_TOKEN_FILE:-@SIMETCONFDIR@/agent.jwt}
AGENT_TOKEN_LOCK=${AGENT_TOKEN_LOCK:-@LOCALSTATEDIR@/lock/simet-agent-token.lock}
API_AGENT_TOKEN=${API_AGENT_TOKEN:-https://api.simet.nic.br/measurement/jwt}
LMAP_AGENT_FILE=${LMAP_AGENT_FILE:-@SIMETCONFDIR@/lmap/agent-id.json}
SIMETMA_RECONFIG=${SIMETMA_RECONFIG:-/etc/init.d/simet-ma reload}
JSONFILTER=${JSONFILTER:-jsonfilter}

# Load hooks and overrides
[ -r @SIMETLIBDIR@/simet_register_ma-hooks.sh ] && . @SIMETLIBDIR@/simet_register_ma-hooks.sh
[ -r @SIMETCONFDIR@/simet_register_ma-hooks.sh ] && . @SIMETCONFDIR@/simet_register_ma-hooks.sh

USERAGENT=$(get_http_useragent)
CURLOPT="$CURL_APIOPT --max-filesize 4000"
CURLOPT2=

case "$1" in
	--boot)
		shift
		CURLOPT2="--retry 3 --retry-max-time 30"
		SIMETMA_RECONFIG=
	;;
esac

#overridable
simet_reginfo_api_call() {
	curl $CURLOPT $CURLOPT2 -A "$USERAGENT" \
		-X POST -f -o "$OUTFILE" \
		-d simetAT="$OLDAT" -d "deviceInfo=$USERAGENT" \
		"$API_AGENT_TOKEN"
}

#overridable
simet_reginfo_api_parse() {
	$JSONFILTER -i "$OUTFILE" -e "AID=@.agentId" -e "AT=@.token"
}

#overridable
simet_reginfo_restart_services() {
	if [ -n "$SIMETMA_RECONFIG" ] ; then
		$SIMETMA_RECONFIG || true
	fi
}

gethash() {
	# $1 - file to hash
	[ -r "$1" ] || {
		echo ""
		return 0
	}
	sha256sum "$1" | sed -n '1 { s/[[:blank:]].*// ; p }'
	return 0
}

write_lmap_agent() {
	if [ -z "$1" ] ; then
		rm -f  "$LMAP_AGENT_FILE"
		simet_log simet-ma daemon.notice "SIMET: removed LMAP agent-id"
	else
		cat <<- LMAPAGENTEOF >"$OUTFILE" || return 1
			{"ietf-lmap-control:lmap":{"agent":{"agent-id":"$1","report-agent-id":true}}}
		LMAPAGENTEOF
		HASHOLD=$(gethash "$LMAP_AGENT_FILE") || HASHOLD=
		HASHNEW=$(gethash "$OUTFILE") || return 1
		[ x"$HASHOLD" != x"$HASHNEW" ] && mv -f "$OUTFILE" "$LMAP_AGENT_FILE" && chmod +r "$LMAP_AGENT_FILE"
	fi
	:
}

gettoken() {
	OLDAT=
	OLDAID=
	[ -r "$AGENT_ID_FILE" ] && OLDAID=$(cat "$AGENT_ID_FILE")
	[ -r "$AGENT_TOKEN_FILE" ] && OLDAT=$(cat "$AGENT_TOKEN_FILE")

	OUTFILE=$(mktemp -q -t simet-at-register.$$.XXXXXXXXXX) || abend "failed to create tmpfile"

	call_hook before_reginfo_api_call

	call simet_reginfo_api_call || abend "failed to contact agent-token service"
	SID=$(call simet_reginfo_api_parse) || abend "illegal response from agent-token service"
	eval "$SID" || abend "internal error"

	call_hook before_reginfo_replace

	[ x"$AID" != x"$OLDAID" ] && echo "$AID" > "$AGENT_ID_FILE"
	[ x"$AT"  != x"$OLDAT"  ] && echo "$AT" > "$AGENT_TOKEN_FILE"

	if [ -n "$LMAP_AGENT_FILE" ] ; then
		LMAP_AGENT_DIR=$(dirname "$LMAP_AGENT_FILE")
		[ -d "$LMAP_AGENT_DIR" ] || {
			mkdir -m 0755 -p "$LMAP_AGENT_DIR"
		}

		write_lmap_agent "$AID"
	fi

	call_hook after_reginfo_replace

	rm -f "$OUTFILE"
	OUTFILE=

	if [ ! -r "$AGENT_ID_FILE" ] || [ -z "$AID" ] || [ ! -r "$AGENT_TOKEN_FILE" ] || [ -z "$AT" ] ; then
		call_hook failed_to_register
		abend "failed to register, please retry later"
	fi

	if [ x"$AID" != x"$OLDAID" ] || [ x"$AT"  != x"$OLDAT"  ] ; then
		simet_log simet-ma daemon.notice "SIMET: agent-id or authorization token has changed"
		call simet_reginfo_restart_services
		call_hook registered_changed
	else
		call_hook registered_nochanges
	fi

	simet_log simet-ma daemon.info "SIMET: LMAP measurement agent id: $AID"
	:
}

AGENT_LOCK_DIR=$(dirname "$AGENT_TOKEN_LOCK")
[ -d "$AGENT_LOCK_DIR" ] || mkdir -p -m 0755 -- "$AGENT_LOCK_DIR"
( flock -n -x 9 && gettoken ) <&- 9>> "$AGENT_TOKEN_LOCK"
